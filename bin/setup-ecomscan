#!/usr/bin/env bash

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== Installing eComscan ===${NC}"

# Load .env
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

CONTAINER_NAME="${PROJECT_NAME}-php"

# Check if container is running
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo -e "${YELLOW}Container $CONTAINER_NAME is not running!${NC}"
    echo "Please start containers first: bin/start"
    exit 1
fi

echo "Installing eComscan in container $CONTAINER_NAME..."

# Install eComscan as www-data
docker exec -it -u www-data "$CONTAINER_NAME" bash -c '
    echo "Downloading eComscan installer..."
    curl -fsSL https://ecomscan.com -o /tmp/ecomscan-install.sh

    echo "Running installer..."
    bash /tmp/ecomscan-install.sh || {
        echo "Interactive install required..."
        echo "Please answer the prompts:"
        echo "  Store root path: /var/www/src"
        echo "  License key: trial"
        echo "  Email: alin.munteanu@roweb.com"
        echo "  Monitoring mode: No"
        bash /tmp/ecomscan-install.sh
    }

    # Cleanup
    rm -f /tmp/ecomscan-install.sh

    echo ""
    echo "eComscan installed in /home/www-data/bin/ecomscan"
'

# Create symlink as root using bin/root
echo ""
echo "Creating symlink as root..."

if bin/root test -f /home/www-data/bin/ecomscan; then
    echo "Found eComscan in /home/www-data/bin/ecomscan"
    bin/root ln -sf /home/www-data/bin/ecomscan /usr/local/bin/ecomscan
    bin/root chmod 755 /home/www-data/bin/ecomscan
    echo "✓ Symlink created: /usr/local/bin/ecomscan -> /home/www-data/bin/ecomscan"
else
    echo "✗ eComscan binary not found in /home/www-data/bin/ecomscan"
    exit 1
fi

# Test as www-data (fără su, direct cu docker exec -u )
echo ""
echo "Testing as www-data user..."
if bin/cli ecomscan --version >/dev/null 2>&1; then
    echo "✓ eComscan is accessible by www-data"
    bin/cli ecomscan --version
else
    echo "✗ eComscan not accessible by www-data"
    echo "Checking installation paths..."
    bin/cli ls -la /home/www-data/bin/ecomscan 2>/dev/null || echo "Not in /home/www-data/bin"
    bin/root ls -la /usr/local/bin/ecomscan 2>/dev/null || echo "No symlink in /usr/local/bin"
fi

echo ""
echo -e "${GREEN}=== eComscan installed successfully! ===${NC}"
echo ""
echo "Test the installation:"
echo "  bin/cli ecomscan --version"
echo ""
echo "Run a test scan:"
echo "  bin/cli ecomscan /var/www/src --key trial"
echo ""
echo "The cron job will run daily at 2 AM (configured in crontab)"
